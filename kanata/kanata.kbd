(include config.kbd)

(defcfg
  log-layer-changes no
  rapid-event-delay 2         ;; adds a certain delay(ms) to have kanata processor output keys in correct order
  process-unmapped-keys no
  block-unmapped-keys no

  danger-enable-cmd yes
  delegate-to-first-layer yes  ;; transparent keys(_) delegate to first-layer only if layer-switch is used to activate the layer
  concurrent-tap-hold yes
)

;; the reduced ANSI QWERTY 60% layout (39-key  layout)
(defsrc
  â†¹   q    w    e    r    t         u    i    o    p   [     ]  ;; 12 keys
  â‡ª   a    s    d    f    g         j    k    l    ;    '    â  ;; 12 keys
  â€¹â‡§  z    x    c    v    b         n    m    ,    .    /    â‡§â€º ;; 12 keys
                â€¹âŒ¥ â€¹â—†          â£          â—†â€º âŒ¥â€º                 ;; 3 keys (2 redundant keys for interoperability b/w diff. keyboards & OS)
)

;;;; TLTR Activation
;; implementation 1
#|
(defchords tl_tr 500
  (tl  ) (layer-while-held TL)
  (  tr) (layer-while-held TR)
  (tl tr) (layer-while-held TLTR)
)
(defalias
  tl (chord tl_tr tl)
  tr (chord tl_tr tr)
)
|#
;;implementation 2
#|
(defalias
  tl (multi nop3 (switch
    (nop4) (layer-while-held TLTR) break
    () (multi (release-layer TLTR) (layer-while-held TL)) break
  ))
  tr (multi nop4 (switch
    (nop3) (layer-while-held TLTR) break
    () (multi (release-layer TLTR) (layer-while-held TR)) break
  ))
)
|#
;; implementation 3
(defvirtualkeys
  release_layer_TLTR (release-layer TLTR)
)

(defalias
  tl     (multi (layer-while-held TL)                         (on-release press-vkey release_layer_TLTR))
  tltltr (multi (layer-while-held TL) (layer-while-held TLTR) (on-release press-vkey release_layer_TLTR))
  tr     (multi (layer-while-held TR)                         (on-release press-vkey release_layer_TLTR))
  trtltr (multi (layer-while-held TR) (layer-while-held TLTR) (on-release press-vkey release_layer_TLTR))
)

(defalias
  ;; chords
  und S-â€ que S-/
  ;; forks
  delf (fork âŒ« (unshift âŒ¦) (â€¹â‡§ â‡§â€º))
  slaf (fork / (unshift \) (â€¹â‡§ â‡§â€º))
  comf (fork , @und (â€¹â‡§ â‡§â€º))
  dotf (fork . @que (â€¹â‡§ â‡§â€º))
)

#|
 Custom Colemak with,
 1. curl mod (mod dh)
 2. wide mod (shifting right hand keys to the right by one key)
 3. angle mod (placement of z in the middle)
|#
(deflayer CUSTOM_COLEMAK
  _     q  w  f  p  b          j    l  u    y      '    ;
  @delf a  r  s  t  g          m    n  e    i      o    _
  _     x  c  d  v  z        @slaf  k  h  @comf  @dotf  _
          @tl @tl       _       @tr @tr
)

(defvar
  os_timeout 300
  cw_timeout 5000
)

(defalias
  ;; chords
  btb S-â†¹
  ;; sticky/one-shot modifiers
  sMet (one-shot-release $os_timeout â€¹â—†)
  sSft (one-shot-release $os_timeout â€¹â‡§)
  sCtl (one-shot-release $os_timeout â€¹âŒƒ)
  sAlt (one-shot-release $os_timeout â€¹âŒ¥)
  sFn (one-shot-release $os_timeout nop0)
  sWin (multi @sAlt @sCtl @sMet)         ;; window-manager key (meant for window manipulation)
  sHyp (multi @sAlt @sCtl @sSft @sMet)   ;; hyper key (meant for application shortcuts)
  ;; forks
  pguf (fork â‡ (unshift â¤’) (â€¹â‡§ â‡§â€º))
  pgdf (fork â‡Ÿ (unshift â¤“) (â€¹â‡§ â‡§â€º))
  ;; caps-word
  cw (caps-word-custom $cw_timeout
    (a b c d e f g h i j k l m n o p q r s t u v w x y z) ;; to be shifted
    (1 2 3 4 5 6 7 8 9 0 â–² â–¼ â—€ â–¶ âŒ« âŒ¦ â€ â€¹â‡§ â‡§â€º)  ;; ignore
  )
)

;; TL (Thumb Left) layer
;; for modifiers & navigation
(deflayer TL
  _ â‹     @sWin @sFn  XX    XX      @pguf  @btb â–²   â†¹  XX  XX
  _ @sAlt @sCtl @sSft @sMet XX      @pgdf  â—€    â–¼   â–¶  @cw _
  _ XX    XX    @sHyp XX    XX      XX     XX   âŒ«   âŒ¦  XX  _
             XX  XX             _          @trtltr @trtltr
)

(defalias
  hpn (unshift â€) equ (unshift â‚Œ)
  ;; chords
  til S-Ë‹ exc S-1 ats S-2 oct S-3 dol S-4 per S-5 car S-6 amp S-7 ast S-8 pao S-9 pac S-0 plu S-â‚Œ
  cuo S-[ cuc S-] pip S-\ ano S-, anc S-.
  ;; symbols' forks
  excf (fork @exc (unshift Ë‹) (â€¹â‡§ â‡§â€º))
  atsf (fork @ats @til (â€¹â‡§ â‡§â€º))
  octf (fork @oct @car (â€¹â‡§ â‡§â€º))
  dolf (fork @dol (unicode â‚¹) (â€¹â‡§ â‡§â€º))
  ampf (fork @amp @pip (â€¹â‡§ â‡§â€º))

  ;; brackets' forks
  curf (fork @cuo @cuc (â€¹â‡§ â‡§â€º))
  parf (fork @pao @pac (â€¹â‡§ â‡§â€º))
  sqrf (fork [ (unshift ]) (â€¹â‡§ â‡§â€º))

  ;; funciton keys' fn-forks
  1f   (fork 1 f1  (nop0))
  2f   (fork 2 f2  (nop0))
  3f   (fork 3 f3  (nop0))
  4f   (fork 4 f4  (nop0))
  5f   (fork 5 f5  (nop0))
  6f   (fork 6 f6  (nop0))
  7f   (fork 7 f7  (nop0))
  8f   (fork 8 f8  (nop0))
  9f   (fork 9 f9  (nop0))
  0f   (fork 0 f10 (nop0))
  astf (fork @ast f11 (nop0))
  perf (fork @per f12 (nop0))
)

;; TR (Thumb Right) layer
;; for symbols & numbers
(deflayer TR
  _  @excf @atsf @octf @dolf XX      @perf  @7f  @8f  @9f  @plu  @equ
  _  @ampf @sqrf @curf @parf XX      @astf  @4f  @5f  @6f  @hpn  _
  _  XX    @ano  @anc  XX    XX      @slaf  @0f  @1f  @2f  @3f   _
       @tltltr @tltltr            _             XX XX
)

(defvirtualkeys
  brightness_up_key (unshift ğŸ”†)
  brightness_down_key (unshift ğŸ”…)
)
(defvar
  osa ("/usr/bin/osascript" "-e")
)
;; media & screen control
(platform (macos)
  (defalias
    ss (cmd /usr/bin/open -a ScreenSaverEngine)
    zz (cmd /usr/bin/pmset sleepnow)
    voli (fork ğŸ”Š (macro (cmd $osa "set volume output volume 100") 275 (unshift ğŸ”Š)) (â€¹â‡§ â‡§â€º))
    voll (fork ğŸ”‰ (macro (cmd $osa "set volume output volume 0") 275 (unshift ğŸ”‰)) (â€¹â‡§ â‡§â€º))
    bri (fork ğŸ”† (macro (on-press press-vkey brightness_up_key) 750 (on-press release-vkey brightness_up_key)) (â€¹â‡§ â‡§â€º))
    brl (fork ğŸ”… (macro (on-press press-vkey brightness_down_key) 750 (on-press release-vkey brightness_down_key)) (â€¹â‡§ â‡§â€º))
  )
)
(platform (linux)
  (defalias
    ss (cmd /usr/bin/xscreensaver-command -activate)
    zz (cmd /usr/bin/xset dpms force off)
    voli (fork ğŸ”Š (cmd /usr/bin/amixer -D pulse sset Master 100%) (â€¹â‡§ â‡§â€º))
    voll (fork ğŸ”‰ (cmd /usr/bin/amixer -D pulse sset Master 0%) (â€¹â‡§ â‡§â€º))
    bri (fork ğŸ”† (cmd /usr/bin/xbacklight -set 100) (â€¹â‡§ â‡§â€º))
    brl (fork ğŸ”… (cmd /usr/bin/xbacklight -set 0) (â€¹â‡§ â‡§â€º))
  )
)
(platform (win winiov2 wintercept)
  (defalias
    ss (cmd nircmd screensaver)
    zz (cmd nircmd standby)
    voli (fork ğŸ”Š (cmd nircmd setsysvolume 65535) (â€¹â‡§ â‡§â€º))
    voll (fork ğŸ”‰ (cmd nircmd setsysvolume 0) (â€¹â‡§ â‡§â€º))
    bri (fork (cmd nircmd changebrightness +10) (cmd nircmd changebrightness +100) (â€¹â‡§ â‡§â€º))
    brl (fork (cmd nircmd changebrightness -10) (cmd nircmd changebrightness -100) (â€¹â‡§ â‡§â€º))
  )
)

(platform (win winiov2 wintercept linux)
  (defalias
    pl pp
  )
)
(platform (macos)
  (defalias
    pl (cmd $osa r#"tell application "Shortcuts Events" to run shortcut "Play/Pause""#)
  )
)

(defalias
  scre (tap-hold 200 500 @ss @zz)
  med (switch
    (â‡§â€º) (unshift â–¶â–¶) break
    (â€¹â‡§) (unshift â—€â—€) break
    () @pl break
  )
)


(environment (KANATA_RSCROLL "")
  (defalias
    mu (switch
      ((and nop2 nop1)) (ğŸ–±â˜¸â†‘ $repeat_delay $slow_scroll_move) break
      (nop1) (ğŸ–±â˜¸â†‘ $repeat_delay $scroll_move) break
      (nop2) (ğŸ–±â†‘ $repeat_delay $slow_mouse_move) break
      () (ğŸ–±â†‘ $repeat_delay $mouse_move) break
    )
    md (switch
      ((and nop2 nop1)) (ğŸ–±â˜¸â†“ $repeat_delay $slow_scroll_move) break
      (nop1) (ğŸ–±â˜¸â†“ $repeat_delay $scroll_move) break
      (nop2) (ğŸ–±â†“ $repeat_delay $slow_mouse_move) break
      () (ğŸ–±â†“ $repeat_delay $mouse_move) break
    )
    mr (switch
      ((and nop2 nop1)) (ğŸ–±â˜¸â†’ $repeat_delay $slow_scroll_move) break
      (nop1) (ğŸ–±â˜¸â†’ $repeat_delay $scroll_move) break
      (nop2) (ğŸ–±â†’ $repeat_delay $slow_mouse_move) break
      () (ğŸ–±â†’ $repeat_delay $mouse_move) break
    )
    ml (switch
      ((and nop2 nop1)) (ğŸ–±â˜¸â† $repeat_delay $slow_scroll_move) break
      (nop1) (ğŸ–±â˜¸â† $repeat_delay $scroll_move) break
      (nop2) (ğŸ–±â† $repeat_delay $slow_mouse_move) break
      () (ğŸ–±â† $repeat_delay $mouse_move) break
    )
  )
)

(environment (KANATA_RSCROLL "1")
  (defalias
    mu (switch
      ((and nop2 nop1)) (ğŸ–±â˜¸â†“ $repeat_delay $slow_scroll_move) break
      (nop1) (ğŸ–±â˜¸â†“ $repeat_delay $scroll_move) break
      (nop2) (ğŸ–±â†‘ $repeat_delay $slow_mouse_move) break
      () (ğŸ–±â†‘ $repeat_delay $mouse_move) break
    )
    md (switch
      ((and nop2 nop1)) (ğŸ–±â˜¸â†‘ $repeat_delay $slow_scroll_move) break
      (nop1) (ğŸ–±â˜¸â†‘ $repeat_delay $scroll_move) break
      (nop2) (ğŸ–±â†“ $repeat_delay $slow_mouse_move) break
      () (ğŸ–±â†“ $repeat_delay $mouse_move) break
    )
    mr (switch
      ((and nop2 nop1)) (ğŸ–±â˜¸â† $repeat_delay $slow_scroll_move) break
      (nop1) (ğŸ–±â˜¸â† $repeat_delay $scroll_move) break
      (nop2) (ğŸ–±â†’ $repeat_delay $slow_mouse_move) break
      () (ğŸ–±â†’ $repeat_delay $mouse_move) break
    )
    ml (switch
      ((and nop2 nop1)) (ğŸ–±â˜¸â†’ $repeat_delay $slow_scroll_move) break
      (nop1) (ğŸ–±â˜¸â†’ $repeat_delay $scroll_move) break
      (nop2) (ğŸ–±â† $repeat_delay $slow_mouse_move) break
      () (ğŸ–±â† $repeat_delay $mouse_move) break
    )
  )
)

;; default switching
(defvirtualkeys
  on_qwerty_layer (layer-while-held QWERTY)
)
(defalias
  slw nop2
  scr nop1
  def (on-press press-vkey on_qwerty_layer)
)

;; TLTR (Thumb Left & Thumb Right) layer
;; for non-keyboard functions like mouse, media, etc.
(deflayer TLTR
  XX @scre @bri @med  @voli XX          XX XX  @mu XX  XX lrld
  XX @slw  XX   @scr  ğŸ–°1   ğŸ–°2         XX @ml @md @mr XX XX
  _  @brl  XX   @voll XX    XX          XX XX  XX  XX  XX _
                XX XX            @def          XX XX
)

(defalias ndef
  (switch
    ((and â€¹â—† â—†â€º)) (on-press release-vkey on_qwerty_layer) break
    ((and â€¹âŒ¥ âŒ¥â€º)) (on-press release-vkey on_qwerty_layer) break
    () â£ break
  )
)

;;ANSI QWERTY layer
(deflayer QWERTY
  â†¹   q    w    e    r    t         u    i    o    p   [     ]
  â‡ª   a    s    d    f    g         j    k    l    ;    '    â
  _   z    x    c    v    b         n    m    ,    .    /    _
              â€¹âŒ¥ â€¹â—†          @ndef          â—†â€º âŒ¥â€º
)