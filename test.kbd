(defcfg
  danger-enable-cmd yes       ;; enable kanata to execute commands
  delegate-to-first-layer no  ;; transparent keys(_) on layers will delegate to the first-layer instead of the defsrc
  process-unmapped-keys yes   ;; enable processing of keys that are not in defsrc.
  block-unmapped-keys no      ;; disable all keys not mapped in defsrc.(process-unmapped-keys must be enabled)
  rapid-event-delay 5         ;; adds a certain delay in milliseconds to have kanata processor output keys in correct order
  concurrent-tap-hold yes     ;; have multiple tap-hold actions run concurrently, i.e. have next tap-hold start its timeout before expiry of the previous
  log-layer-changes yes       ;; logging has some processing overhead. Doesn't log only layer changes.
)

(defvar
  tap_timeout   100
  hold_timeout  200
  one_shot_timeout 300
  ;; shortened vars
  tt $tap_timeout
  ht $hold_timeout
  ost $one_shot_timeout
)

(deftemplate shift-fork (key when_shifted_key)
  (fork $key (multi (release-key sft) $when_shifted_key) (lsft rsft))
)

(deftemplate fn-fork (key key_fn)
  (fork $key (unmod $key_fn) (fn))
)

;; Aliases for keys accessible only via shifting
(defalias
  til S-grv exc S-1 ats S-2 oct S-3 dol S-4 per S-5 car S-6 amp S-7 ast S-8 pao S-9 pac S-0 und S-min plu S-eql
  btb S-tab                                                                                   cuo S-[ cuc S-] pip S-\
                                                                        ano S-comm anc S-. que S-/
)

;; Aliases for keys that are certainly to be unshifted
(defalias
  gra (unshift grv) one (unshift 1) two (unshift 2) thr (unshift 3) fou (unshift 4) fiv (unshift 5) six (unshift 6) sev (unshift 7) eig (unshift 8) nin (unshift 9) zer (unshift 0) hpn (unshift min) equ (unshift eql)
                                                                                         sbc (unshift [) sbo (unshift ]) bsl (unshift \)
                                                                                         com (unshift comm) dot (unshift .) fsl (unshift /)
)

;; the reduced ANSI QWERTY 60% layout (39-key layout)
(defsrc
  tab    q    w    e    r    t         u    i    o    p   [     ]    ;; 12 keys
  caps   a    s    d    f    g         j    k    l    ;    '    ret  ;; 12 keys
  lsft   z    x    c    v    b         n    m    ,    .    /    rsft ;; 12 keys
                lalt lmet         spc          rmet ralt             ;; 3  keys (2 redundant keys for interoperability b/w diff. keyboards & OS)
)


;; TLTR Activation
;; implementation 1
#| (defchords tl_tr 500
  (tl  ) (layer-while-held TL)
  (  tr) (layer-while-held TR)
  (tl tr) (layer-while-held TLTR)
)
(defalias
  tl (chord tl_tr tl)
  tr (chord tl_tr tr)
)|#
;;implementation 2
#| (defalias
  tl (multi nop3 (switch
    (nop4) (layer-while-held tltr) break
    () (multi (release-layer tltr) (layer-while-held tl)) break
  ))
  tr (multi nop4 (switch
    (nop3) (layer-while-held tltr) break
    () (multi (release-layer tltr) (layer-while-held tr)) break
  ))
)|#
;; implementation 3
(defvirtualkeys
  release_layer_TLTR  (release-layer TLTR)
)

(defalias
 tl (multi (layer-while-held TL) (on-release tap-vkey release_layer_TLTR))
 tr (multi (layer-while-held TR) (on-release tap-vkey release_layer_TLTR))
 tltltr (multi (layer-while-held TL) (layer-while-held TLTR) (on-release tap-vkey release_layer_TLTR))
 trtltr (multi (layer-while-held TR) (layer-while-held TLTR) (on-release tap-vkey release_layer_TLTR))
)

(defalias
  delf (template-expand shift-fork bspc del)
  slaf (template-expand shift-fork @fsl @bsl)
  comf (template-expand shift-fork @com @und)
  dotf (template-expand shift-fork @dot @que)
)

#| first-layer
 Custom Colemak, imet,
 1. curl mod (mod dh)
 2. wide mod (shifting right hand keys to the right by one key)
 3. angle mod (placement of z in the middle)
|#
(deflayer CUSTOM_COLEMAK
  tab      q    w    f    p    b        j    l    u    y     '     ;
  @delf    a    r    s    t    g        m    n    e    i     o     ret
  lsft     x    c    d    v    z      @slaf  k    h   @comf @dotf  rsft
                 @tl @tl           spc        @tr @tr
)

(defalias
  ;; sticky modifiers
  ;; set of keys one-shot's gonna ignore
  sPnk (one-shot-press $ost lalt)
  sMid (one-shot-press $ost lsft)
  sFn (one-shot-press $ost fn)
  sWin (multi
    (one-shot-press $ost lmet)
    (one-shot-press $ost lctl)
    (one-shot-press $ost lalt)
  ) ;; window manager key (meant for window manipulation)
  sHyp (multi
    (one-shot $ost lmet)
    (one-shot $ost lctl)
    (one-shot $ost lalt)
    (one-shot $ost lsft)
  ) ;; hyper key (meant for application shortcuts)

  cw (caps-word-custom 3000
    (a b c d e f g h i j k l m n o p q r s t u v w x y z)
    (1 2 3 4 5 6 7 8 9 0 left down up rght bspc del - rsft lsft)
  )

  pguf (template-expand shift-fork pgup home)
  pgdf (template-expand shift-fork pgdn end)
)

(platform (macos)
  (defalias
    sPnt (one-shot-press $ost lmet)
    sRng (one-shot-press $ost lctl)
  )
)

(platform (win winiov2 wintercept linux)
  (defalias
    sPnt (one-shot-press $ost lctl)
    sRng (one-shot-press $ost lmet)
  )
)

;; TL (Thumb Left) layer for modifiers & navigation
(deflayer TL
  _ esc   @sWin XX    XX    XX      @pguf  @btb up   tab  rpt-any XX
  _ @sPnk @sRng @sMid @sPnt XX      @pgdf  left down rght @cw     _
  _ @sFn  XX    @sHyp XX    XX      XX     XX   bspc del  XX      _
            @tl  @tl             _          @trtltr @trtltr
)


(defalias
  ;; symbols' forks
  ampf (template-expand shift-fork @amp @til)
  pipf (template-expand shift-fork @pip @gra)

  ;; brackets' forks
  curf (template-expand shift-fork @cuo @cuc)
  parf (template-expand shift-fork @pao @pac)
  sqrf (template-expand shift-fork @sbo @sbc)

  ;; funciton keys' fn-forks
  1f (template-expand fn-fork @one f1)
  2f (template-expand fn-fork @two f2)
  3f (template-expand fn-fork @thr f3)
  4f (template-expand fn-fork @fou f4)
  5f (template-expand fn-fork @fiv f5)
  6f (template-expand fn-fork @six f6)
  7f (template-expand fn-fork @sev f7)
  8f (template-expand fn-fork @eig f8)
  9f (template-expand fn-fork @nin f9)
  0f (template-expand fn-fork @zer f10)
  astf (template-expand fn-fork @ast f11)
  perf (template-expand fn-fork @per f12)
)

;; TR (Thumb Right) layer (symbols & numbers)
(deflayer TR
  _     @exc  @ats  @oct  @dol  @car      @perf  @7f   @8f   @9f   @plu  @equ
  @delf @ampf @pipf @curf @parf @sqrf     @astf  @4f   @5f   @6f   @hpn  _
  _     XX    @ano  @anc  XX    XX        @slaf  @0f   @1f   @2f   @3f   _
          @tltltr @tltltr              _            @tr @tr
)

(platform (macos)
  (defalias
    ss (cmd /usr/bin/open -a ScreenSaverEngine)
    zz (cmd /usr/bin/pmset sleepnow)
    bru brup
    brd brdown
  )
)

(platform (linux)
  (defalias
    ss (cmd "/usr/bin/open -a ScreenSaverEngine")
    zz (cmd "/usr/bin/pmset sleepnow")
    bru brup
    brd brdown
  )
)

(platform (win winiov2 wintercept)
  (defalias
    ss (cmd powershell.exe -NoProfile -Command nircmd screensaver)
    zz (cmd powershell.exe -NoProfile -Command nircmd standby)
    bru (cmd powershell.exe -NoProfile -Command nircmd changebrightness +20)
    brd (cmd powershell.exe -NoProfile -Command nircmd changebrightness -20)
  )
)

(defalias
  scref (template-expand shift-fork @ss @zz)

  voldf (template-expand shift-fork vold mute)
  medif (template-expand shift-fork next prev)

  ;; Dynamic macro
  dms dynamic-macro-record-stop
  dst (dynamic-macro-record-stop-truncate 4)
  dr (dynamic-macro-record 0)
  dp (dynamic-macro-play 0)

  dmr (tap-dance 200 (@dr @dst))

  ;; TODO:
  ;; [ ] unicode
  ;; [ ] dynamic-macro
  ;; [ ] windows (brightness & sleep & screensaver)
  ;; [ ] fn fork
  ;; [ ] symbols uncomfortable(~, `)
  ;; [ ] defoverrides
  ;; [ ] double tapping modifiers in the TL layer locks it until double tapped again
)

(defalias
  slw nop0
  scr nop1

  ;; mouse
  mu (switch
    ((and nop0 nop1)) (mwheel-up 25 25) break
    (nop1) (mwheel-up 25 80) break
    (nop0) (movemouse-up 25 15) break
    () (movemouse-up 25 25) break
  )
  md (switch
    ((and nop0 nop1)) (mwheel-down 25 25) break
    (nop1) (mwheel-down 25 80) break
    (nop0) (movemouse-down 25 15) break
    () (movemouse-down 25 25) break
  )
  mr (switch
    ((and nop0 nop1)) (mwheel-right 25 25) break
    (nop1) (mwheel-right 25 80) break
    (nop0) (movemouse-right 25 15) break
    () (movemouse-right 25 25) break
  )
  ml (switch
    ((and nop0 nop1)) (mwheel-left 25 25) break
    (nop1) (mwheel-left 25 80) break
    (nop0) (movemouse-left 25 15) break
    () (movemouse-left 25 25) break
  )
)

(defvirtualkeys
  emp (layer-while-held Empty)
)

(defalias
  pemp (on-press press-vkey emp)
)

;;TLTR (Thumb Left & Thumb Right) layer (non-keyboard functions like mouse, media, etc.)
(deflayer TLTR
  XX @scref @bru   pp     volu XX            XX XX  @mu XX  XX XX
  XX @slw   @scr   XX     mlft mrgt          XX @ml @md @mr XX lrld
  _  @brd   @medif @voldf XX   XX            XX XX  XX  XX  XX _
          @tltltr @tltltr           @pemp      @trtltr  @trtltr
)

(defalias
  remp (on-press release-vkey emp)

  nemp (switch
    ((and lmet rmet)) @remp break
    ((and lalt ralt)) @remp break
    () spc break
  )
)

;; Empty layer for switching back to QWERTY
(deflayer Empty
  _ _ _ _ _ _          _ _ _ _ _ _
  _ _ _ _ _ _          _ _ _ _ _ _
  _ _ _ _ _ _          _ _ _ _ _ _
     _ _        @nemp      _ _
)
